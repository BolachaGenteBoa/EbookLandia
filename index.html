<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EbookLandia - Marketplace</title>
    
    <style>
        /* --- CSS GERAL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f4f7f6; color: #333; overflow-x: hidden; padding-top: 80px; }

        /* HEADER */
        header { background: #2d3436; color: white; padding: 1rem 5%; position: fixed; top: 0; width: 100%; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        nav { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .logo span { color: #00cec9; }
        .user-controls { display: flex; gap: 15px; align-items: center; }
        .btn-sair { background: #d63031; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        /* SALDO FLUTUANTE */
        .saldo-container { position: fixed; top: 90px; right: 20px; z-index: 998; }
        .saldo-card { background: white; padding: 10px 15px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; border: 2px solid #6c5ce7; }
        .saldo-card .valor { font-weight: bold; color: #2d3436; font-size: 1.1rem; }
        .btn-add { background: #00cec9; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        
        /* ADM */
        .adm-bar { background: #ff7675; color: white; padding: 10px 5%; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #d63031; }
        
        /* VITRINE */
        .hero { text-align: center; padding: 40px 20px; background: #fff; margin-bottom: 20px; }
        .vitrine { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 0 5% 40px; }
        .card-ebook { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; position: relative; transition: transform 0.2s; }
        .card-ebook:hover { transform: translateY(-5px); }
        .card-ebook img { width: 100%; height: 220px; object-fit: cover; border-radius: 5px; }
        .btn-comprar { background: #2d3436; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        .btn-comprar:hover { background: #00cec9; }

        /* SISTEMA DE PAGAMENTO (Visual) */
        .pagamento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .metodo-pag { border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; }
        .metodo-pag.selected { border-color: #00cec9; background: #e0f7fa; }
        .qr-fake { width: 150px; height: 150px; background: #eee; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #999; border: 2px dashed #ccc; }

        /* MODAIS */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; width: 90%; max-width: 450px; border-radius: 12px; position: relative; animation: slideDown 0.3s; }
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .btn-confirmar { background: #27ae60; color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-fechar { background: #ff7675; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; margin-top: 5px; cursor: pointer; }
        
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <header>
        <nav>
            <div class="logo">Ebook<span>Landia</span></div>
            <div class="user-controls">
                <div style="font-size: 0.9rem;">Ol√°, <span id="display-username" style="font-weight:bold;">...</span></div>
                <button class="btn-sair" onclick="sair()">Sair</button>
            </div>
        </nav>
    </header>

    <div class="saldo-container">
        <div class="saldo-card">
            <span class="label">Carteira:</span>
            <span class="valor">R$ <span id="user-saldo">0.00</span></span>
            <button class="btn-add" onclick="abrirModal('modal-pagamento')" title="Adicionar Saldo">+</button>
        </div>
    </div>

    <div id="painel-adm" class="adm-bar" style="display: none;">
        <span>üëë Painel do CEO</span>
        <div>
            <button onclick="abrirModal('modal-vender')" style="background:white; color:#d63031; border:none; padding:5px 10px; cursor:pointer; font-weight:bold; border-radius:3px;">+ Cadastrar Livro</button>
            <button onclick="zerarBanco()" style="background:#2d3436; color:white; border:none; padding:5px 10px; cursor:pointer; margin-left:5px; border-radius:3px;">Resetar Sistema</button>
        </div>
    </div>

    <div class="hero">
        <h2>Marketplace de Ebooks</h2>
        <p>Compre, leia e venda. Simples assim.</p>
    </div>

    <main>
        <div class="vitrine" id="vitrine">
            <p style="text-align:center; width:100%; color:#666;">Carregando livros...</p>
        </div>
    </main>

    <div id="modal-pagamento" class="modal">
        <div class="modal-content">
            <h3>üí∞ Adicionar Saldo</h3>
            <p>Escolha o m√©todo de pagamento:</p>
            <div class="pagamento-grid">
                <div class="metodo-pag selected" onclick="selecionarMetodo(this, 'pix')">Pix (Instant√¢neo)</div>
                <div class="metodo-pag" onclick="selecionarMetodo(this, 'card')">Cart√£o de Cr√©dito</div>
            </div>
            <div id="area-pix" style="text-align:center; margin-top:15px;">
                <p>Escaneie o QR Code:</p>
                <div class="qr-fake">QR CODE FICT√çCIO</div>
                <p style="font-size:0.8rem; color:#00cec9;">Copiar Chave Pix Aleat√≥ria</p>
            </div>
            <div id="area-card" style="display:none; margin-top:15px;">
                <input type="text" placeholder="N√∫mero do Cart√£o">
                <div style="display:flex; gap:5px;">
                    <input type="text" placeholder="MM/AA">
                    <input type="text" placeholder="CVV">
                </div>
            </div>
            <hr style="margin:15px 0;">
            <label>Valor da Recarga (R$):</label>
            <input type="number" id="valor-recarga" placeholder="0.00">
            <button class="btn-confirmar" onclick="processarPagamento()">PAGAR AGORA</button>
            <button class="btn-fechar" onclick="fecharModal('modal-pagamento')">Cancelar</button>
        </div>
    </div>

    <div id="modal-vender" class="modal">
        <div class="modal-content">
            <h3>Novo Livro</h3>
            <input type="text" id="titulo-livro" placeholder="T√≠tulo do Livro">
            <input type="number" id="preco-livro" placeholder="Pre√ßo (R$)">
            <input type="text" id="capa-livro" placeholder="URL da Capa (Imagem)">
            <button class="btn-confirmar" onclick="salvarLivro()">Cadastrar</button>
            <button class="btn-fechar" onclick="fecharModal('modal-vender')">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDB9azJhGclPOlfT249fcLWiztUSt88GY8",
            authDomain: "ebooklandia-f041a.firebaseapp.com",
            projectId: "ebooklandia-f041a",
            storageBucket: "ebooklandia-f041a.firebasestorage.app",
            messagingSenderId: "385658292639",
            appId: "1:385658292639:web:3b9255d914c303ff3e95aa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VERIFICA√á√ÉO DE SEGURAN√áA (O PULO DO GATO) ---
        let usuarioLogado = null;
        
        try {
            const dadosSalvos = localStorage.getItem("usuarioEbook");
            if(!dadosSalvos) {
                window.location.href = "login.html"; // Manda pro login se n√£o tiver dados
            } else {
                usuarioLogado = JSON.parse(dadosSalvos);
                inicializarSistema();
            }
        } catch(e) {
            window.location.href = "login.html";
        }

        async function inicializarSistema() {
            // Atualiza dados frescos do banco
            try {
                const userRef = doc(db, "usuarios", usuarioLogado.id);
                const userSnap = await getDoc(userRef);
                if(userSnap.exists()) {
                    usuarioLogado = { id: userSnap.id, ...userSnap.data() };
                    // Atualiza localStorage
                    localStorage.setItem("usuarioEbook", JSON.stringify(usuarioLogado));
                }
            } catch(e) { console.log("Usando cache local"); }

            document.getElementById("display-username").innerText = usuarioLogado.username;
            atualizarSaldoTela();
            verificarPermissoes();
            carregarLivros();
        }

        // --- FUN√á√ïES GLOBAIS ---
        window.sair = () => {
            localStorage.removeItem("usuarioEbook");
            window.location.href = "login.html";
        }

        window.abrirModal = (id) => { document.getElementById(id).style.display = "block"; }
        window.fecharModal = (id) => { document.getElementById(id).style.display = "none"; }

        window.selecionarMetodo = (elem, tipo) => {
            document.querySelectorAll('.metodo-pag').forEach(d => d.classList.remove('selected'));
            elem.classList.add('selected');
            if(tipo === 'pix') {
                document.getElementById('area-pix').style.display = 'block';
                document.getElementById('area-card').style.display = 'none';
            } else {
                document.getElementById('area-pix').style.display = 'none';
                document.getElementById('area-card').style.display = 'block';
            }
        }

        function atualizarSaldoTela() {
            document.getElementById("user-saldo").innerText = usuarioLogado.saldo.toFixed(2);
        }

        window.processarPagamento = async () => {
            const valor = parseFloat(document.getElementById("valor-recarga").value);
            if(valor > 0) {
                const btn = document.querySelector("#modal-pagamento .btn-confirmar");
                btn.innerText = "Processando...";
                
                setTimeout(async () => {
                    const novoSaldo = usuarioLogado.saldo + valor;
                    await updateDoc(doc(db, "usuarios", usuarioLogado.id), { saldo: novoSaldo });
                    usuarioLogado.saldo = novoSaldo;
                    localStorage.setItem("usuarioEbook", JSON.stringify(usuarioLogado));
                    atualizarSaldoTela();
                    
                    alert("‚úÖ Pagamento Aprovado!");
                    btn.innerText = "PAGAR AGORA";
                    window.fecharModal("modal-pagamento");
                }, 1500);
            } else {
                alert("Valor inv√°lido.");
            }
        }

        async function carregarLivros() {
            const vitrine = document.getElementById("vitrine");
            
            const snapshot = await getDocs(collection(db, "livros"));
            vitrine.innerHTML = "";

            if(snapshot.empty) {
                vitrine.innerHTML = "<p>Nenhum livro √† venda.</p>";
                return;
            }

            snapshot.forEach(docLivro => {
                const livro = docLivro.data();
                const div = document.createElement("div");
                div.className = "card-ebook";
                div.innerHTML = `
                    <img src="${livro.capa}" onerror="this.src='https://via.placeholder.com/200?text=Capa+Indisponivel'">
                    <h3>${livro.titulo}</h3>
                    <p>R$ ${livro.preco}</p>
                    <button class="btn-comprar" onclick="comprarLivro('${docLivro.id}', ${livro.preco}, '${livro.titulo}')">Comprar</button>
                    ${usuarioLogado.cargo === 'CEO' ? `<button onclick="deletarLivro('${docLivro.id}')" style="color:red; background:none; border:none; cursor:pointer; font-size:0.8rem; margin-top:5px;">[X] Remover</button>` : ''}
                `;
                vitrine.appendChild(div);
            });
        }

        window.salvarLivro = async () => {
            const titulo = document.getElementById("titulo-livro").value;
            const preco = parseFloat(document.getElementById("preco-livro").value);
            const capa = document.getElementById("capa-livro").value;

            if(titulo && preco) {
                await addDoc(collection(db, "livros"), {
                    titulo: titulo, preco: preco, capa: capa || "https://via.placeholder.com/200"
                });
                alert("Livro cadastrado!");
                window.fecharModal("modal-vender");
                carregarLivros();
            } else { alert("Preencha os dados."); }
        }

        window.comprarLivro = async (id, preco, titulo) => {
            if(usuarioLogado.saldo >= preco) {
                if(confirm(`Comprar "${titulo}" por R$ ${preco}?`)) {
                    const novoSaldo = usuarioLogado.saldo - preco;
                    await updateDoc(doc(db, "usuarios", usuarioLogado.id), { saldo: novoSaldo });
                    usuarioLogado.saldo = novoSaldo;
                    localStorage.setItem("usuarioEbook", JSON.stringify(usuarioLogado));
                    atualizarSaldoTela();
                    alert(`Compra realizada com sucesso!`);
                }
            } else {
                alert("Saldo insuficiente!");
                window.abrirModal("modal-pagamento");
            }
        }

        function verificarPermissoes() {
            if(usuarioLogado.cargo === "CEO") {
                document.getElementById("painel-adm").style.display = "flex";
            }
        }

        window.deletarLivro = async (id) => {
            if(confirm("Apagar livro?")) {
                await deleteDoc(doc(db, "livros", id));
                carregarLivros();
            }
        }

        window.zerarBanco = async () => {
            if(prompt("Digite DELETAR para confirmar:") === "DELETAR") {
                const snapshot = await getDocs(collection(db, "livros"));
                snapshot.forEach(async (doc) => { await deleteDoc(doc.ref); });
                alert("Site resetado.");
                carregarLivros();
            }
        }
    </script>
</body>
</html>
