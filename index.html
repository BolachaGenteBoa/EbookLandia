<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EbookLandia - Login</title>
    
    <style>
        /* --- CSS GERAL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f4f7f6; color: #333; overflow-x: hidden; }

        /* --- TELA DE LOGIN --- */
        #tela-login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 90%; max-width: 400px;
        }
        .login-card h2 { margin-bottom: 20px; color: #2d3436; }
        .login-card input {
            width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #dfe6e9;
            border-radius: 8px; font-size: 1rem; outline: none; transition: 0.3s;
        }
        .login-card input:focus { border-color: #6c5ce7; }
        .btn-entrar {
            width: 100%; padding: 15px; background: #00cec9; color: white; border: none;
            border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .btn-entrar:hover { background: #00b894; transform: scale(1.02); }

        /* --- APLICA√á√ÉO PRINCIPAL (Escondida no inicio) --- */
        #app-principal { display: none; padding-top: 80px; }

        /* HEADER */
        header { background: #2d3436; color: white; padding: 1rem 5%; position: fixed; top: 0; width: 100%; z-index: 100; }
        nav { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .logo span { color: #00cec9; }
        .user-info { font-size: 0.9rem; color: #dfe6e9; }

        /* SALDO FLUTUANTE */
        .saldo-container { position: fixed; top: 90px; right: 20px; z-index: 998; }
        .saldo-card { background: white; padding: 10px 15px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; border: 2px solid #6c5ce7; }
        .saldo-card .valor { font-weight: bold; color: #2d3436; font-size: 1.1rem; }
        .btn-add { background: #00cec9; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        
        /* ADM */
        .adm-bar { background: #ff7675; color: white; padding: 10px 5%; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #d63031; }
        
        /* VITRINE */
        .hero { text-align: center; padding: 40px 20px; background: #fff; margin-bottom: 20px; }
        .vitrine { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 0 5% 40px; }
        .card-ebook { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; position: relative; transition: transform 0.2s; }
        .card-ebook:hover { transform: translateY(-5px); }
        .card-ebook img { width: 100%; height: 220px; object-fit: cover; border-radius: 5px; }
        .btn-comprar { background: #2d3436; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        .btn-comprar:hover { background: #00cec9; }

        /* SISTEMA DE PAGAMENTO (Visual) */
        .pagamento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .metodo-pag { border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; }
        .metodo-pag.selected { border-color: #00cec9; background: #e0f7fa; }
        .qr-fake { width: 150px; height: 150px; background: #eee; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #999; border: 2px dashed #ccc; }

        /* MODAIS */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; width: 90%; max-width: 450px; border-radius: 12px; position: relative; animation: slideDown 0.3s; }
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .btn-confirmar { background: #27ae60; color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-fechar { background: #ff7675; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; margin-top: 5px; cursor: pointer; }
        
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
        .aviso-vermelho { color: #c0392b; background: #ffcccc; padding: 10px; border-radius: 5px; font-weight: bold; font-size: 0.8rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="tela-login">
        <div class="login-card">
            <h1>EbookLandia üìö</h1>
            <p>Fa√ßa login para acessar sua biblioteca.</p>
            <br>
            <input type="text" id="login-user" placeholder="Nome de Usu√°rio (Ex: Bolacha)">
            <input type="password" id="login-pass" placeholder="Senha (Qualquer uma)">
            <button class="btn-entrar" id="btn-entrar-sistema">ENTRAR NO SISTEMA</button>
            <p style="font-size:0.8rem; margin-top:10px; color:#666;">*Se n√£o tiver conta, ela ser√° criada automaticamente.</p>
        </div>
    </div>

    <div id="app-principal">
        
        <header>
            <nav>
                <div class="logo">Ebook<span>Landia</span></div>
                <div class="user-info">Ol√°, <span id="display-username">Visitante</span></div>
            </nav>
        </header>

        <div class="saldo-container">
            <div class="saldo-card">
                <span class="label">Carteira:</span>
                <span class="valor">R$ <span id="user-saldo">0.00</span></span>
                <button class="btn-add" onclick="abrirModal('modal-pagamento')" title="Adicionar Saldo">+</button>
            </div>
        </div>

        <div id="painel-adm" class="adm-bar" style="display: none;">
            <span>üëë Painel do CEO</span>
            <div>
                <button onclick="abrirModal('modal-vender')" style="background:white; color:#d63031; border:none; padding:5px 10px; cursor:pointer; font-weight:bold; border-radius:3px;">+ Cadastrar Livro</button>
                <button onclick="zerarBanco()" style="background:#2d3436; color:white; border:none; padding:5px 10px; cursor:pointer; margin-left:5px; border-radius:3px;">Resetar Sistema</button>
            </div>
        </div>

        <div class="hero">
            <h2>Marketplace de Ebooks</h2>
            <p>Compre, leia e venda. Simples assim.</p>
        </div>

        <main>
            <div class="vitrine" id="vitrine">
                <p style="text-align:center; width:100%; color:#666;">Carregando livros...</p>
            </div>
        </main>

        <div id="modal-pagamento" class="modal">
            <div class="modal-content">
                <h3>üí∞ Adicionar Saldo</h3>
                <p>Escolha o m√©todo de pagamento:</p>
                
                <div class="pagamento-grid">
                    <div class="metodo-pag selected" onclick="selecionarMetodo(this, 'pix')">Pix (Instant√¢neo)</div>
                    <div class="metodo-pag" onclick="selecionarMetodo(this, 'card')">Cart√£o de Cr√©dito</div>
                </div>

                <div id="area-pix" style="text-align:center; margin-top:15px;">
                    <p>Escaneie o QR Code:</p>
                    <div class="qr-fake">QR CODE FICT√çCIO</div>
                    <p style="font-size:0.8rem; color:#00cec9;">Copiar Chave Pix Aleat√≥ria</p>
                </div>

                <div id="area-card" style="display:none; margin-top:15px;">
                    <input type="text" placeholder="N√∫mero do Cart√£o">
                    <div style="display:flex; gap:5px;">
                        <input type="text" placeholder="MM/AA">
                        <input type="text" placeholder="CVV">
                    </div>
                </div>

                <hr style="margin:15px 0;">
                <label>Valor da Recarga (R$):</label>
                <input type="number" id="valor-recarga" placeholder="0.00">
                <button class="btn-confirmar" onclick="processarPagamento()">PAGAR AGORA</button>
                <button class="btn-fechar" onclick="fecharModal('modal-pagamento')">Cancelar</button>
            </div>
        </div>

        <div id="modal-vender" class="modal">
            <div class="modal-content">
                <h3>Novo Livro</h3>
                <input type="text" id="titulo-livro" placeholder="T√≠tulo do Livro">
                <input type="number" id="preco-livro" placeholder="Pre√ßo (R$)">
                <input type="text" id="capa-livro" placeholder="URL da Capa (Imagem)">
                <button class="btn-confirmar" onclick="salvarLivro()">Cadastrar</button>
                <button class="btn-fechar" onclick="fecharModal('modal-vender')">Fechar</button>
            </div>
        </div>

    </div>

    <script type="module">
        // Importando Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, setDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // CONFIGURA√á√ÉO DO FIREBASE (N√ÉO APAGUE)
        const firebaseConfig = {
            apiKey: "AIzaSyDB9azJhGclPOlfT249fcLWiztUSt88GY8",
            authDomain: "ebooklandia-f041a.firebaseapp.com",
            projectId: "ebooklandia-f041a",
            storageBucket: "ebooklandia-f041a.firebasestorage.app",
            messagingSenderId: "385658292639",
            appId: "1:385658292639:web:3b9255d914c303ff3e95aa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VARI√ÅVEIS GLOBAIS
        let usuarioLogado = null; // Guarda os dados de quem logou

        // --- SISTEMA DE LOGIN ---
        document.getElementById("btn-entrar-sistema").addEventListener("click", async () => {
            const user = document.getElementById("login-user").value.trim();
            const pass = document.getElementById("login-pass").value.trim();

            if(!user) return alert("Digite um nome de usu√°rio!");

            const btn = document.getElementById("btn-entrar-sistema");
            btn.innerText = "Verificando...";
            btn.disabled = true;

            try {
                // Procura se usu√°rio j√° existe
                const q = query(collection(db, "usuarios"), where("username", "==", user));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // CRIA NOVO USU√ÅRIO
                    let cargoInicial = "Leitor";
                    if (user.toLowerCase() === "bolacha") cargoInicial = "CEO"; // O Pulo do Gato

                    const novoUser = {
                        username: user,
                        saldo: 0,
                        cargo: cargoInicial,
                        criadoEm: new Date()
                    };
                    const docRef = await addDoc(collection(db, "usuarios"), novoUser);
                    usuarioLogado = { id: docRef.id, ...novoUser };
                } else {
                    // CARREGA USU√ÅRIO EXISTENTE
                    const dados = snapshot.docs[0];
                    usuarioLogado = { id: dados.id, ...dados.data() };
                    
                    // Garante que Bolacha √© sempre CEO se ele logar
                    if(user.toLowerCase() === "bolacha" && usuarioLogado.cargo !== "CEO") {
                        await updateDoc(doc(db, "usuarios", usuarioLogado.id), { cargo: "CEO" });
                        usuarioLogado.cargo = "CEO";
                    }
                }

                // Libera o acesso
                document.getElementById("tela-login").style.display = "none";
                document.getElementById("app-principal").style.display = "block";
                document.getElementById("display-username").innerText = usuarioLogado.username;
                atualizarSaldoTela();
                verificarPermissoes();
                carregarLivros();

            } catch (error) {
                console.error(error);
                alert("Erro ao conectar. Verifique se o link deste site est√° nos 'Authorized Domains' do Firebase.");
                btn.innerText = "Tentar Novamente";
                btn.disabled = false;
            }
        });

        // --- FUN√á√ïES GLOBAIS (CONECTADAS AO WINDOW PARA O HTML USAR) ---

        window.abrirModal = (id) => { document.getElementById(id).style.display = "block"; }
        window.fecharModal = (id) => { document.getElementById(id).style.display = "none"; }

        // Sele√ß√£o Visual de Pix ou Cart√£o
        window.selecionarMetodo = (elem, tipo) => {
            document.querySelectorAll('.metodo-pag').forEach(d => d.classList.remove('selected'));
            elem.classList.add('selected');
            if(tipo === 'pix') {
                document.getElementById('area-pix').style.display = 'block';
                document.getElementById('area-card').style.display = 'none';
            } else {
                document.getElementById('area-pix').style.display = 'none';
                document.getElementById('area-card').style.display = 'block';
            }
        }

        // --- SISTEMA DE PAGAMENTO E SALDO ---
        function atualizarSaldoTela() {
            document.getElementById("user-saldo").innerText = usuarioLogado.saldo.toFixed(2);
        }

        window.processarPagamento = async () => {
            const valor = parseFloat(document.getElementById("valor-recarga").value);
            if(valor > 0) {
                const btn = document.querySelector("#modal-pagamento .btn-confirmar");
                btn.innerText = "Processando...";
                
                // Simula delay de banco
                setTimeout(async () => {
                    const novoSaldo = usuarioLogado.saldo + valor;
                    await updateDoc(doc(db, "usuarios", usuarioLogado.id), { saldo: novoSaldo });
                    usuarioLogado.saldo = novoSaldo;
                    atualizarSaldoTela();
                    
                    alert("‚úÖ Pagamento Aprovado!\nSaldo adicionado com sucesso.");
                    btn.innerText = "PAGAR AGORA";
                    window.fecharModal("modal-pagamento");
                }, 1500);
            } else {
                alert("Digite um valor v√°lido.");
            }
        }

        // --- SISTEMA DE LIVROS (COMPRA E VENDA) ---
        async function carregarLivros() {
            const vitrine = document.getElementById("vitrine");
            vitrine.innerHTML = "Carregando estante...";
            
            const snapshot = await getDocs(collection(db, "livros"));
            vitrine.innerHTML = "";

            if(snapshot.empty) {
                vitrine.innerHTML = "<p>Nenhum livro √† venda. Seja o primeiro a vender!</p>";
                return;
            }

            snapshot.forEach(docLivro => {
                const livro = docLivro.data();
                const div = document.createElement("div");
                div.className = "card-ebook";
                div.innerHTML = `
                    <img src="${livro.capa}" onerror="this.src='https://via.placeholder.com/200?text=Capa+Indisponivel'">
                    <h3>${livro.titulo}</h3>
                    <p>R$ ${livro.preco}</p>
                    <button class="btn-comprar" onclick="comprarLivro('${docLivro.id}', ${livro.preco}, '${livro.titulo}')">Comprar</button>
                    ${usuarioLogado.cargo === 'CEO' ? `<button onclick="deletarLivro('${docLivro.id}')" style="color:red; background:none; border:none; cursor:pointer; font-size:0.8rem; margin-top:5px;">[X] Remover</button>` : ''}
                `;
                vitrine.appendChild(div);
            });
        }

        window.salvarLivro = async () => {
            const titulo = document.getElementById("titulo-livro").value;
            const preco = parseFloat(document.getElementById("preco-livro").value);
            const capa = document.getElementById("capa-livro").value;

            if(titulo && preco) {
                await addDoc(collection(db, "livros"), {
                    titulo: titulo,
                    preco: preco,
                    capa: capa || "https://via.placeholder.com/200",
                    vendedor: usuarioLogado.username
                });
                alert("Livro cadastrado com sucesso!");
                window.fecharModal("modal-vender");
                carregarLivros();
            } else {
                alert("Preencha t√≠tulo e pre√ßo.");
            }
        }

        window.comprarLivro = async (id, preco, titulo) => {
            if(usuarioLogado.saldo >= preco) {
                if(confirm(`Deseja comprar "${titulo}" por R$ ${preco}?`)) {
                    const novoSaldo = usuarioLogado.saldo - preco;
                    await updateDoc(doc(db, "usuarios", usuarioLogado.id), { saldo: novoSaldo });
                    usuarioLogado.saldo = novoSaldo;
                    atualizarSaldoTela();
                    alert(`Compra realizada!\nO download de "${titulo}" come√ßar√° em breve.`);
                }
            } else {
                alert("Saldo insuficiente! Clique no '+' para adicionar dinheiro.");
                window.abrirModal("modal-pagamento");
            }
        }

        // --- SISTEMA DE ADMINISTRA√á√ÉO ---
        function verificarPermissoes() {
            if(usuarioLogado.cargo === "CEO") {
                document.getElementById("painel-adm").style.display = "flex";
            }
        }

        window.deletarLivro = async (id) => {
            if(confirm("Tem certeza que quer apagar esse livro do site?")) {
                await deleteDoc(doc(db, "livros", id));
                carregarLivros();
            }
        }

        window.zerarBanco = async () => {
            if(prompt("Digite 'DELETAR' para apagar todos os livros do site:") === "DELETAR") {
                const snapshot = await getDocs(collection(db, "livros"));
                snapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });
                alert("Banco de dados limpo.");
                carregarLivros();
            }
        }

    </script>
</body>
</html>
