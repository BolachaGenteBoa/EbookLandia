<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EbookLandia - Vers√£o Final</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        /* HEADER FIXO */
        header { 
            background: #2d3436; color: white; padding: 0 5%; 
            position: fixed; top: 0; width: 100%; height: 70px;
            z-index: 1000; display: flex; justify-content: space-between; align-items: center;
        }

        body { background-color: #f0f2f5; padding-top: 130px; }

        .wallet-display { 
            background: #00cec9; color: #2d3436; padding: 8px 15px; 
            border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px;
        }

        /* PAINEL DE FERRAMENTAS (CEO/MODERADOR) */
        .adm-bar { 
            position: fixed; top: 70px; left: 0; width: 100%; 
            background: #dfe6e9; padding: 10px 5%; z-index: 999; 
            display: none; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #b2bec3;
        }

        /* GRID DE LIVROS */
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 280px; object-fit: cover; cursor: pointer; }
        .card-body { padding: 15px; text-align: center; }

        /* EDITOR E MODAIS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 50px auto; padding: 25px; border-radius: 10px; position: relative; }
        .editor-area { background: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-top: 10px; }
        #preview-desc { min-height: 80px; border: 1px dashed #ccc; padding: 10px; margin-top: 10px; background: white; }

        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-pay { background: #27ae60; color: white; width: 100%; }
        .btn-adm { background: #0984e3; color: white; margin-left: 5px; }
        
        /* PIX */
        .pix-box { text-align: center; border: 2px solid #00cec9; padding: 15px; border-radius: 10px; margin-top: 10px; }
        .qr-img { width: 200px; height: 200px; margin: 10px auto; }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 1.5rem; font-weight: bold;">Ebook<span style="color:#00cec9">Landia</span></div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="wallet-display">
                R$ <span id="user-saldo">0.00</span>
                <button onclick="abrirModal('modal-recarga')" style="border:none; border-radius:50%; width:22px; cursor:pointer;">+</button>
            </div>
            <button onclick="sair()" style="background:none; border:1px solid white; color:white; padding:5px; cursor:pointer;">Sair</button>
        </div>
    </header>

    <div id="painel-ferramentas" class="adm-bar">
        <span id="txt-cargo" style="font-weight:bold; color:#2d3436;">Painel de Controle</span>
        <div>
            <button class="btn btn-adm" style="background:#27ae60" onclick="validarPagamentoPix()">‚úÖ Validar Pix (Moderador)</button>
            <button id="btn-novo-livro" class="btn btn-adm" onclick="abrirModal('modal-vender')">+ Novo Livro</button>
            <button id="btn-promover" class="btn btn-adm" onclick="promoverModerador()">+ Contratar Moderador</button>
        </div>
    </div>

    <div class="container">
        <div class="grid" id="vitrine"></div>
    </div>

    <div id="modal-recarga" class="modal">
        <div class="modal-content">
            <h3>Recarregar Saldo</h3>
            <input type="number" id="valor-pix" placeholder="Quanto deseja recarregar? R$" style="width:100%; padding:10px; margin:15px 0;">
            <button class="btn btn-pay" onclick="gerarQR()">Gerar QR Code Pix</button>
            
            <div id="pix-area" style="display:none;" class="pix-box">
                <img id="qr-display" class="qr-img" src="">
                <p>Chave: <b>bruh100br@gmail.com</b></p>
                <p style="font-size: 0.8rem; color: #666; margin-top:5px;">Pague e envie o print para o Moderador!</p>
            </div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="fecharModal('modal-recarga')">Fechar</button>
        </div>
    </div>

    <div id="modal-vender" class="modal">
        <div class="modal-content">
            <h3>Configurar Ebook</h3>
            <input type="text" id="v-titulo" placeholder="T√≠tulo do Livro" style="width:100%; padding:10px; margin:5px 0;">
            <input type="number" id="v-preco" placeholder="Pre√ßo R$" style="width:100%; padding:10px; margin:5px 0;">
            <input type="text" id="v-capa" placeholder="Link da Capa (Imagem)" style="width:100%; padding:10px; margin:5px 0;">
            
            <div class="editor-area">
                <p><b>Descri√ß√£o/Conte√∫do (HTML Liberado):</b></p>
                <textarea id="v-desc" oninput="updatePreview()" placeholder="Ex: <h1 style='color:red'>Destaque</h1>" style="width:100%; height:80px;"></textarea>
                <div id="preview-desc"></div>
            </div>
            <br>
            <button class="btn btn-pay" onclick="salvarLivro()">Publicar</button>
            <button class="btn" style="width:100%; margin-top:5px;" onclick="fecharModal('modal-vender')">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDB9azJhGclPOlfT249fcLWiztUSt88GY8",
            authDomain: "ebooklandia-f041a.firebaseapp.com",
            projectId: "ebooklandia-f041a",
            storageBucket: "ebooklandia-f041a.firebasestorage.app",
            messagingSenderId: "385658292639",
            appId: "1:385658292639:web:3b9255d914c303ff3e95aa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let user = JSON.parse(localStorage.getItem("usuarioEbook"));
        if(!user) window.location.href = "login.html";

        async function init() {
            const snap = await getDoc(doc(db, "usuarios", user.id));
            if(snap.exists()) {
                user = { id: snap.id, ...snap.data() };
                document.getElementById("user-saldo").innerText = user.saldo.toFixed(2);
                
                // Configura interface
                if(user.cargo === "CEO" || user.cargo === "Moderador") {
                    document.getElementById("painel-ferramentas").style.display = "flex";
                    document.getElementById("txt-cargo").innerText = user.cargo === "CEO" ? "üëë Painel CEO" : "üõ†Ô∏è Painel Moderador";
                    if(user.cargo === "Moderador") {
                        document.getElementById("btn-novo-livro").style.display = "none";
                        document.getElementById("btn-promover").style.display = "none";
                    }
                }
            }
            carregarVitrine();
        }

        window.gerarQR = () => {
            const v = document.getElementById("valor-pix").value;
            if(v > 0) {
                const link = `https://chart.googleapis.com/chart?cht=qr&chs=250x250&chl=00020126360014BR.GOV.BCB.PIX0114bruh100br@gmail.com520400005303986540${v}5802BR5913EbookLandia6009SAO_PAULO62070503***6304`;
                document.getElementById("qr-display").src = link;
                document.getElementById("pix-area").style.display = "block";
            }
        }

        window.updatePreview = () => {
            document.getElementById("preview-desc").innerHTML = document.getElementById("v-desc").value;
        }

        window.validarPagamentoPix = async () => {
            const cliente = prompt("Nome do usu√°rio:");
            const valor = parseFloat(prompt("Valor a liberar (R$):"));
            if(cliente && valor > 0) {
                const q = query(collection(db, "usuarios"), where("username", "==", cliente));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    const ref = doc(db, "usuarios", snap.docs[0].id);
                    await updateDoc(ref, { saldo: (snap.docs[0].data().saldo || 0) + valor });
                    alert("Saldo liberado!");
                }
            }
        }

        window.promoverModerador = async () => {
            const n = prompt("Nome do novo Moderador:");
            if(n) {
                const q = query(collection(db, "usuarios"), where("username", "==", n));
                const snap = await getDocs(q);
                if(!snap.empty) await updateDoc(doc(db, "usuarios", snap.docs[0].id), { cargo: "Moderador" });
            }
        }

        window.carregarVitrine = async () => {
            const grid = document.getElementById("vitrine");
            const snap = await getDocs(collection(db, "livros"));
            grid.innerHTML = "";
            snap.forEach(d => {
                const l = d.data();
                grid.innerHTML += `
                    <div class="card">
                        <img src="${l.capa}">
                        <div class="card-body">
                            <h3>${l.titulo}</h3>
                            <p style="color:green; font-weight:bold;">R$ ${l.preco.toFixed(2)}</p>
                            <button class="btn btn-pay" style="margin-top:10px;" onclick="alert('Funcionalidade de compra ativada!')">Comprar</button>
                        </div>
                    </div>`;
            });
        }

        window.salvarLivro = async () => {
            await addDoc(collection(db, "livros"), {
                titulo: document.getElementById("v-titulo").value,
                preco: parseFloat(document.getElementById("v-preco").value),
                capa: document.getElementById("v-capa").value,
                descricao: document.getElementById("v-desc").value
            });
            fecharModal('modal-vender');
            carregarVitrine();
        }

        window.abrirModal = (id) => document.getElementById(id).style.display = "block";
        window.fecharModal = (id) => document.getElementById(id).style.display = "none";
        window.sair = () => { localStorage.removeItem("usuarioEbook"); window.location.href = "login.html"; }

        init();
    </script>
</body>
</html>
