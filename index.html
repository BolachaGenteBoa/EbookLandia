<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EbookLandia - Marketplace Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f2f5; color: #1c1e21; padding-top: 70px; }

        /* HEADER */
        header { background: #2d3436; color: white; padding: 10px 5%; position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .logo span { color: #00cec9; }
        .user-bar { display: flex; align-items: center; gap: 15px; }

        /* SALDO */
        .wallet-card { background: white; padding: 8px 15px; border-radius: 20px; border: 2px solid #6c5ce7; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .btn-plus { background: #00cec9; border: none; width: 25px; height: 25px; border-radius: 50%; color: white; cursor: pointer; }

        /* VITRINE */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 10px; overflow: hidden; shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 300px; object-fit: cover; }
        .card-content { padding: 15px; }
        .price { color: #27ae60; font-size: 1.2rem; font-weight: bold; }
        
        /* MODAIS */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 50px auto; padding: 25px; border-radius: 10px; position: relative; }
        
        /* EDITOR DE EBOOK */
        .editor-area { background: #f9f9f9; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; }
        #preview-desc { min-height: 100px; border: 1px dashed #ccc; padding: 10px; margin-top: 10px; background: white; }

        /* PIX AREA */
        .pix-box { text-align: center; border: 2px solid #00cec9; padding: 20px; border-radius: 10px; margin-top: 15px; }
        .qr-code { width: 200px; height: 200px; margin: 10px auto; background: #eee; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 10px; }
        .status-pending { background: #ffeaa7; color: #d35400; }
        .status-success { background: #55efc4; color: #00b894; }

        .btn-main { background: #6c5ce7; color: white; border: none; padding: 12px 20px; border-radius: 5px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-close { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 1.5rem; }
        
        .badge-dev { background: #eb4d4b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; position: absolute; top: 10px; left: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">Ebook<span>Landia</span></div>
        <div class="user-bar">
            <div class="wallet-card">
                R$ <span id="user-saldo">0.00</span>
                <button class="btn-plus" onclick="abrirModal('modal-recarga')">+</button>
            </div>
            <button onclick="sair()" style="background:none; border:1px solid white; color:white; padding:5px; cursor:pointer;">Sair</button>
        </div>
    </header>

    <div class="container">
        <div id="adm-bar" style="display:none; background:#2d3436; color:white; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <span>üõ°Ô∏è Painel Bolacha (CEO)</span>
            <div>
                <button onclick="liberarSaldoManual()" style="background:#f1c40f; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold; margin-right: 10px;">‚úÖ Liberar Saldo</button>
                <button onclick="abrirModal('modal-vender')" style="background:#00cec9; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">+ Novo Ebook Profissional</button>
            </div>
        </div>

        <div class="grid" id="vitrine"></div>
    </div>

    <div id="modal-recarga" class="modal">
        <div class="modal-content">
            <span class="btn-close" onclick="fecharModal('modal-recarga')">&times;</span>
            <h3>Recarregar via Pix</h3>
            <p>Valor da recarga:</p>
            <input type="number" id="valor-pix" placeholder="Ex: 20.00" style="width:100%; padding:10px; font-size:1.2rem;">
            
            <button class="btn-main" onclick="gerarPagamentoPix()">Gerar QR Code</button>

            <div id="pix-display" style="display:none;">
                <div class="pix-box">
                    <img id="qr-img" class="qr-code" src="" alt="QR Code Pix">
                    <p style="font-size:0.8rem; margin:10px 0;">Chave: <strong>bruh100br@gmail.com</strong></p>
                    <div id="payment-status" class="status-badge status-pending">Aguardando confirma√ß√£o do moderador...</div>
                    <p style="font-size:0.7rem; color: #666; margin-top: 10px;">Ap√≥s o pagamento, envie o comprovante.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-vender" class="modal">
        <div class="modal-content">
            <span class="btn-close" onclick="fecharModal('modal-vender')">&times;</span>
            <h3>Configurar Novo Ebook</h3>
            <input type="text" id="v-titulo" placeholder="T√≠tulo do Livro" style="width:100%; padding:10px; margin:10px 0;">
            <input type="number" id="v-preco" placeholder="Pre√ßo (R$)" style="width:100%; padding:10px; margin:10px 0;">
            <input type="text" id="v-capa" placeholder="URL da Imagem de Capa" style="width:100%; padding:10px; margin:10px 0;">
            
            <div class="editor-area">
                <p><strong>Descri√ß√£o do Conte√∫do (Suporta HTML):</strong></p>
                <textarea id="v-desc" oninput="updatePreview()" placeholder="Use <img> para fotos, <h1 style='color:red'> para t√≠tulos..." style="width:100%; height:100px; margin-top:5px;"></textarea>
                <div id="preview-desc"></div>
            </div>

            <label style="margin-top:10px; display:block;">
                <input type="checkbox" id="v-privado"> Tornar este livro de TESTE (S√≥ Bolacha v√™)
            </label>

            <button class="btn-main" onclick="salvarLivro()">Publicar Agora</button>
        </div>
    </div>

    <div id="modal-detalhes" class="modal">
        <div class="modal-content">
            <span class="btn-close" onclick="fecharModal('modal-detalhes')">&times;</span>
            <div id="detalhe-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDB9azJhGclPOlfT249fcLWiztUSt88GY8",
            authDomain: "ebooklandia-f041a.firebaseapp.com",
            projectId: "ebooklandia-f041a",
            storageBucket: "ebooklandia-f041a.firebasestorage.app",
            messagingSenderId: "385658292639",
            appId: "1:385658292639:web:3b9255d914c303ff3e95aa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let usuario = JSON.parse(localStorage.getItem("usuarioEbook"));
        if(!usuario) window.location.href = "login.html";

        async function init() {
            const snap = await getDoc(doc(db, "usuarios", usuario.id));
            if(snap.exists()) {
                usuario = { id: snap.id, ...snap.data() };
                localStorage.setItem("usuarioEbook", JSON.stringify(usuario));
            }
            document.getElementById("user-saldo").innerText = usuario.saldo.toFixed(2);
            if(usuario.cargo === "CEO") document.getElementById("adm-bar").style.display = "flex";
            carregarVitrine();
        }

        window.carregarVitrine = async () => {
            const grid = document.getElementById("vitrine");
            const snap = await getDocs(collection(db, "livros"));
            grid.innerHTML = "";

            snap.forEach(d => {
                const l = d.data();
                if(l.privado && usuario.username.toLowerCase() !== "bolacha") return;

                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
                    ${l.privado ? '<span class="badge-dev">TESTE</span>' : ''}
                    <img src="${l.capa}" onclick="verDetalhes('${d.id}')" style="cursor:pointer">
                    <div class="card-content">
                        <h3>${l.titulo}</h3>
                        <p class="price">R$ ${l.preco.toFixed(2)}</p>
                        <button class="btn-main" style="background:#2d3436" onclick="comprar('${d.id}', ${l.preco})">Comprar</button>
                        ${usuario.cargo === 'CEO' ? `<button onclick="remover('${d.id}')" style="margin-top:10px; color:red; border:none; background:none; cursor:pointer;">Remover</button>` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- SISTEMA DE DEP√ìSITO MANUAL (ANTI-GOLPE) ---
        window.liberarSaldoManual = async () => {
            const nomeCliente = prompt("Digite o nome EXATO do usu√°rio que fez o Pix:");
            const valorPago = parseFloat(prompt("Qual valor (R$) deve ser liberado?"));

            if(nomeCliente && valorPago > 0) {
                const q = query(collection(db, "usuarios"), where("username", "==", nomeCliente));
                const querySnapshot = await getDocs(q);

                if(!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const novoSaldo = userDoc.data().saldo + valorPago;
                    await updateDoc(doc(db, "usuarios", userDoc.id), { saldo: novoSaldo });
                    alert(`‚úÖ Sucesso! R$ ${valorPago} adicionados √† conta de ${nomeCliente}.`);
                    if(nomeCliente === usuario.username) init(); // Atualiza se for o pr√≥prio CEO
                } else {
                    alert("Usu√°rio n√£o encontrado!");
                }
            }
        }

        window.gerarPagamentoPix = () => {
            const valor = document.getElementById("valor-pix").value;
            if(!valor || valor <= 0) return alert("Digite um valor!");

            const pixLink = `https://chart.googleapis.com/chart?cht=qr&chs=250x250&chl=00020126360014BR.GOV.BCB.PIX0114bruh100br@gmail.com520400005303986540${valor}5802BR5913EbookLandia6009SAO_PAULO62070503***6304`;
            
            document.getElementById("qr-img").src = pixLink;
            document.getElementById("pix-display").style.display = "block";
            
            const status = document.getElementById("payment-status");
            status.className = "status-badge status-pending";
            status.innerText = "Aguardando confirma√ß√£o do moderador...";
            
            alert("QR Code gerado! Realize o pagamento e aguarde a libera√ß√£o pelo moderador.");
        }

        window.updatePreview = () => {
            document.getElementById("preview-desc").innerHTML = document.getElementById("v-desc").value;
        }

        window.salvarLivro = async () => {
            const l = {
                titulo: document.getElementById("v-titulo").value,
                preco: parseFloat(document.getElementById("v-preco").value),
                capa: document.getElementById("v-capa").value,
                descricao: document.getElementById("v-desc").value,
                privado: document.getElementById("v-privado").checked
            };
            await addDoc(collection(db, "livros"), l);
            fecharModal('modal-vender');
            carregarVitrine();
        }

        window.verDetalhes = async (id) => {
            const d = await getDoc(doc(db, "livros", id));
            const l = d.data();
            document.getElementById("detalhe-body").innerHTML = `
                <img src="${l.capa}" style="width:100%; border-radius:10px;">
                <h2 style="margin:15px 0;">${l.titulo}</h2>
                <div style="border-top: 1px solid #eee; padding-top:15px;">
                    ${l.descricao}
                </div>
                <button class="btn-main" onclick="comprar('${id}', ${l.preco})">Comprar agora por R$ ${l.preco}</button>
            `;
            abrirModal('modal-detalhes');
        }

        window.comprar = async (id, preco) => {
            if(usuario.saldo >= preco) {
                if(confirm("Confirmar compra?")) {
                    usuario.saldo -= preco;
                    await updateDoc(doc(db, "usuarios", usuario.id), { saldo: usuario.saldo });
                    document.getElementById("user-saldo").innerText = usuario.saldo.toFixed(2);
                    alert("Livro comprado! Conte√∫do liberado.");
                }
            } else {
                alert("Sem saldo!");
                abrirModal('modal-recarga');
            }
        }

        window.remover = async (id) => { if(confirm("Apagar?")) { await deleteDoc(doc(db, "livros", id)); carregarVitrine(); } }
        window.abrirModal = (id) => document.getElementById(id).style.display = "block";
        window.fecharModal = (id) => document.getElementById(id).style.display = "none";
        window.sair = () => { localStorage.removeItem("usuarioEbook"); window.location.href = "login.html"; }

        init();
    </script>
</body>
</html>
